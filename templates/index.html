{% extends 'base.html' %}

{% block content %}
<!-- base에 옮기실 것 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" />
<div class="row container" style="height: 400px">


    <div class="col-xl-6">
        <video id="video" width="320" height="240"
            style="background-color: aliceblue; background-image: url(/static/images/stady_bear_head.png); background-repeat: no-repeat; background-position: 50% 50%; border-radius:5px "
            autoplay></video>
        <canvas id="canvas" width="960" height="720" style="display: none"></canvas>

        <p class="stady_btn mt-3">
            <span class="btn btn-lg btn-primary fw-bold border-black" style="width: 300px; margin-bottom: 10px"
                onclick="pushStartBtn()">공부시작
            </span>
            <span class="btn btn-lg btn-outline-danger fw-bold border-black" style="width: 300px; margin-bottom: 10px"
                onclick="pushFinishBtn()">공부종료
            </span>
        </p>
    </div>
    <div class="col-xl-6" style="height: 400px; overflow-y: scroll; border-radius: 5px; background-color: aliceblue; ">
        <div>
            <h3 class="text-center" id="today-date"></h3>
            <div id="today-log">
                {% for log in study_log_list %}
                <div class="row mb-2">
                    <div class="col-4">{{log.start_time}} ~ {{log.end_time}}</div>
                    <div class="col-8 row">
                        <div class="col-8" id="memo-{{log.id}}"">{{log.memo}}</div>
                        <div class=" col-4 text-end">
                            <button onclick="writeMemo(`{{log.id}}`)" type="button" class="btn btn-success"
                                style="font-size : 12px;" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                                메모/수정
                            </button>

                        </div>
                    </div>
                </div>

                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Memo</h1>
                <button type="button" onclick="closeMemo()" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>어떤 걸 공부하셨나요??</h5>
                <input type="text" id="memo-title">
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="memo-submin-btn">저장</button>
            </div>
        </div>
    </div>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- 추후에 지웠다 다시 그리는 방식이 아닌 추가&변경으로 사용 가능한 것으로 변경하기 -->
<script>
    $.ajaxSetup({
        headers: {
            'X-CSRFToken': '{{csrf_token}}',
        },
    });
    //날짜 변수
    const date = new Date()
    const todayDate = document.getElementById('today-date')

    const todayLog = document.getElementById('today-log');

    // 비디오 변수
    var video = document.getElementById('video');
    var localstream;
    var video = document.getElementById('video');

    // 캔버스 뱐수 & 설정
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');


    document.addEventListener("DOMContentLoaded", function () {
        console.log(date.toDateString())
        console.log(date.toLocaleDateString())
        console.log(date.toLocaleTimeString)
        todayDate.innerText = date.toLocaleDateString('ko-kr')
    });



    function uploadImage() {
        context.drawImage(video, 0, 0, 960, 720);
        var drawCanvas = document.getElementById('canvas');

        var request = $.ajax({
            type: 'POST',

            data: { imgUpload: drawCanvas.toDataURL('image/png') }, // 이미지를 인코딩

            url: '/study/check/',

            success: function (result) {
                console.log(result);
                logList = result['study_log_list'];
                insertLog(logList);
            },
        });
    }


    function insertLog(logList) {
        if (logList) {
            let totalTemp = '';
            for (let i = 0; i < logList.length; i++) {
                let temp = `
                
                <div class="row mb-2">
                    <div class="col-4">${logList[i]["start_time"]} ~ ${logList[i]["end_time"]}</div>
                    <div class="col-8 row">
                        <div class="col-8" id="memo-${logList[i]["id"]}">${logList[i]["memo"]}</div>
                        <div class=" col-4 text-end">
                            <button onclick="writeMemo(${logList[i]["id"]})" type="button" class="btn btn-success" style="font-size : 12px;"
                                data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                                메모/수정
                            </button>

                        </div>
                    </div>
                </div>
                `;
                totalTemp += temp;
            }
            $('#today-log').empty();
            $('#today-log').append(totalTemp);
        }
    }



    function startStudy() {
        $.ajax({
            type: 'GET',

            data: {},

            url: '/study/start/',

            success: function (result) {
                console.log('성공:', result);
                logList = result['study_log_list'];
                insertLog(logList)
            },
        });
    }

    function finishStudy() {
        $.ajax({
            type: 'GET',

            data: {},

            url: '/study/finish/',

            success: function (result) {
                console.log('finishStudy()');

                logList = result['study_log_list'];

                insertLog(logList)
            },
        });
    }

    function writeMemo(logId) {
        let modal = document.getElementById('staticBackdrop');
        let submitButton = document.getElementById('memo-submin-btn');
        let memo = document.getElementById(`memo-${logId}`);
        let memoTitle = document.getElementById('memo-title');


        modal.setAttribute('class', 'modal fade show');
        modal.setAttribute('style', 'display: block;');
        submitButton.setAttribute('onclick', `submitMemo(${logId})`)
        memoTitle.value = memo.innerText;

        // modal.setAttribute('class', 'modal fade show');
        // modal.removeAttribute('style');
    }

    function submitMemo(logId) {
        var memoTitle = document.getElementById('memo-title').value;
        var memo = document.getElementById(`memo-${logId}`);
        console.log(memoTitle, memo)

        $.ajax({
            type: 'POST',

            data: { memoTitle: memoTitle, logId: logId },

            url: '/study/memo/',

            success: function (result) {
                console.log('성공:', result);
                memo.innerText = '';
                memo.append(memoTitle);

            }
        });

        closeMemo()
    }

    function closeMemo() {
        let modal = document.getElementById('staticBackdrop');
        let memoTitle = document.getElementById('memo-title');
        let submitButton = document.getElementById('memo-submin-btn');

        // modal.removeAttribute('style');
        memoTitle.value = null;
        submitButton.removeAttribute('onclick');
    }

    function pushStartBtn() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices
                .getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    localstream = stream;
                    video.play();
                });
        }
        startStudy();
        root = setInterval(uploadImage, 5000); // 반복 시키는 함수
    }
    function pushFinishBtn() {
        console.log('pushFinishBtn() 확인');
        clearInterval(root);
        setTimeout(finishStudy, 1500); //이미지 처리 전 코드 실행 방지
        video.pause();
        video.src = '';
        localstream.getTracks()[0].stop();
    }
</script>

{% endblock %}