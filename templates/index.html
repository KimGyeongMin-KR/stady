<!-- base에 옮기실 것 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.2/js/bootstrap.min.js"></script>




<div class="row container" >
    <div class="col-lg-6">
        <video id="video" width="320" height="240" style="border: 1px solid black" autoplay></video>
        <canvas id="canvas" width="960" height="720" style="display: none"></canvas>

        <p class="stady_btn">
            <span href="#" class="btn btn-lg btn-secondary fw-bold border-black bg-white"
                style="width: 300px; margin-bottom: 10px" onclick="pushStartBtn()">공부시작
            </span>
            <span class="btn btn-lg btn-secondary fw-bold border-black bg-white"
                style="width: 300px; margin-bottom: 10px" onclick="pushFinishBtn()">공부종료
            </span>
            <span href="#" class="btn btn-lg btn-secondary fw-bold border-black bg-white"
                style="width: 300px; margin-bottom: 10px">내 공부 로그
            </span>
        </p>
    </div>
    <div class="col-lg-6" style="height: 400px; overflow-y: scroll; border: 1px solid black;">
        <div>
            <h3 class="text-center">오늘날짜</h3>
            <div id="today-log">
                {% for log in study_log_list %}
                <div class="row">
                    <div class="col-4 ">
                        {{log.start_time}} ~ {{log.end_time}}
                    </div>
                    <div class="col-8 row">
                        <div class="col-8">
                            메모란
                        </div>
                        <div class="col-4 text-end">
                            <button onclick="writeMemo(`{{log.id}}`)">
                                메모/수정
                            </button>
                        </div>
                        
                    </div>
                </div>
                    
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    Launch static backdrop modal
  </button>
  
  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">닫기</button>
        </div>
        <div class="modal-body">
          <input type="text">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Understood</button>
        </div>
      </div>
    </div>
  </div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- 추후에 지웠다 다시 그리는 방식이 아닌 추가&변경으로 사용 가능한 것으로 변경하기 -->
<script>
    $.ajaxSetup({
        headers: {
            "X-CSRFToken": '{{csrf_token}}'
        }
    });

    const todayLog = document.getElementById('today-log')
    var video = document.getElementById('video');
    var localstream;

    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    var video = document.getElementById('video');


    function uploadImage() {
        context.drawImage(video, 0, 0, 960, 720);
        var drawCanvas = document.getElementById('canvas');

        var request = $.ajax({

            type: 'POST',

            data: { imgUpload: drawCanvas.toDataURL('image/png') }, // 이미지를 인코딩

            url: '/study/check/',

            success: function (result) {
                stdLogList = result['study_log_list']
                if (stdLogList) {
                    let totalTemp = ''
                    for (let i = 0; i < stdLogList.length; i++) {
                        let temp = `
                        <div>
                            ${stdLogList[i]['start_time']} ~ ${stdLogList[i]['end_time']}
                        </div>
                        `
                        totalTemp += temp
                    }
                    $('#today-log').empty()
                    $('#today-log').append(totalTemp)

                }
            }

        });

    }

    function startStudy() {
        $.ajax({

            type: 'GET',

            data: {},

            url: '/study/start/',

            success: function (result) {

                stdLogList = result['study_log_list']
                if (stdLogList) {
                    let totalTemp = ''
                    for (let i = 0; i < stdLogList.length; i++) {
                        let temp = `
                    <div>
                        ${stdLogList[i]['start_time']} ~ ${stdLogList[i]['end_time']}
                    </div>
                    `
                        totalTemp += temp
                    }
                    $('#today-log').empty()
                    $('#today-log').append(totalTemp)

                }
            }
        });
    }

    function finishStudy() {
        $.ajax({

            type: 'GET',

            data: {},

            url: '/study/finish/',

            success: function (result) {
                stdLogList = result['study_log_list']

                if (stdLogList) {
                    let totalTemp = ''
                    for (let i = 0; i < stdLogList.length; i++) {
                        let temp = `
                    <div>
                        ${stdLogList[i]['start_time']} ~ ${stdLogList[i]['end_time']}
                    </div>
                    `
                        totalTemp += temp
                    }
                    $('#today-log').empty()
                    $('#today-log').append(totalTemp)

                }
            }
        });
    }


    function writeMemo(logId){

    }


    function pushStartBtn() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {

                video.srcObject = stream;
                localstream = stream;
                video.play();
            });
        }
        startStudy()
        root = setInterval(uploadImage, 5000); // 반복 시키는 함수
    }
    function pushFinishBtn() {
        clearInterval(root);
        setTimeout(finishStudy, 3000) //이미지 처리 전 코드 실행 방지
        video.pause();
        video.src = "";
        localstream.getTracks()[0].stop();
    }
</script>

<!-- 시작 누르고 새로고침 이후 종료 버튼 누를 시 오류 -->
<!-- 브러우저 종료 인식후 참여 종료 시점 지정 -->